<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess: Defensive Reward Bot</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #board { width: 400px; max-width: 90vw; border: 5px solid #444; }
        .info { margin: 15px; font-size: 1.1rem; color: #00ffcc; }
        #log { width: 400px; height: 100px; background: #000; margin-top: 10px; font-family: monospace; font-size: 12px; overflow-y: scroll; padding: 5px; color: #00ff00; border: 1px solid #333; }
        button { padding: 10px 15px; cursor: pointer; background: #333; color: white; border: 1px solid #555; border-radius: 4px; margin: 5px; }
    </style>
</head>
<body>

    <div class="info" id="status">Your Turn</div>
    <div id="board"></div>

    <div class="controls">
        <button onclick="resetGame()">Reset</button>
        <button onclick="board.flip()">Flip</button>
    </div>
    
    <div id="log">Bot Logic: Points based on Center, Defense, and Threats...</div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        var board = null;
        var game = new Chess();

        const REWARDS = {
            CENTER: 40,    // High reward for d4, d5, e4, e5
            ATTACK: 25,    // Reward for attacking your pieces
            DEFEND: 20,    // Reward for pieces protecting each other
            THREAT: -100   // MASSIVE penalty if the bot's piece is being attacked
        };

        function evaluateBoard() {
            let score = 0;
            const pieces = game.board();

            // Loop through the 8x8 board
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = pieces[r][c];
                    if (!piece) continue;

                    let square = String.fromCharCode(97 + c) + (8 - r);

                    if (piece.color === 'b') { // Bot is Black
                        // 1. Material Value
                        score += getPieceValue(piece.type);

                        // 2. Center Control
                        if (r >= 3 && r <= 4 && c >= 3 && c <= 4) score += REWARDS.CENTER;

                        // 3. Threat Detection (The "Loser" Points)
                        if (isAttackedByWhite(square)) {
                            score += REWARDS.THREAT;
                        }
                    }
                }
            }
            return score;
        }

        // Helper: Is a specific square being attacked by White?
        function isAttackedByWhite(square) {
            // We use chess.js internal logic to see if white can move to this square
            // We temporarily flip the turn to check attacker coverage
            let currentTurn = game.turn();
            let attacked = false;
            
            // To check if white attacks a square, it must be white's "turn" in the logic
            // so we can see their legal moves
            const moves = game.moves({ verbose: true });
            attacked = moves.some(m => m.to === square);
            
            return attacked;
        }

        function getPieceValue(type) {
            const vals = { p: 100, n: 320, b: 330, r: 500, q: 900, k: 20000 };
            return vals[type] || 0;
        }

        function makeBotMove() {
            const moves = game.moves();
            if (moves.length === 0) return;

            let bestMove = null;
            let bestValue = -Infinity;

            // Look ahead 1 move for every possibility
            moves.forEach(move => {
                game.move(move);
                let boardValue = evaluateBoard();
                game.undo();

                if (boardValue > bestValue) {
                    bestValue = boardValue;
                    bestMove = move;
                }
            });

            game.move(bestMove);
            board.position(game.fen());
            $('#log').prepend("<div>Bot moved " + bestMove + " | Score: " + bestValue + "</div>");
            updateStatus();
        }

        function onDrop(source, target) {
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            updateStatus();
            window.setTimeout(makeBotMove, 500);
        }

        function updateStatus() {
            let status = game.turn() === 'w' ? "White to Move" : "Bot Thinking...";
            if (game.in_checkmate()) status = "Checkmate!";
            $('#status').text(status);
        }

        function resetGame() {
            game.reset();
            board.start();
            $('#log').empty();
            updateStatus();
        }

        board = Chessboard('board', {
            draggable: true,
            position: 'start',
            onDrop: onDrop,
            onSnapEnd: function() { board.position(game.fen()); },
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
    </script>
</body>
</html>
