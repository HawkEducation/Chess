<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess: Ultimate Tactical Suite</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { background: #1a1a1a; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #board { width: 400px; max-width: 90vw; border: 5px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .info { margin: 15px; font-size: 1.2rem; color: #00ffcc; font-weight: bold; height: 30px; }
        #log { width: 400px; height: 120px; background: #000; margin-top: 10px; font-family: 'Courier New', monospace; font-size: 13px; overflow-y: auto; padding: 10px; color: #00ff00; border: 1px solid #333; }
        .controls { margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
        button { padding: 10px 15px; cursor: pointer; background: #333; color: white; border: 1px solid #555; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        button:hover { background: #444; border-color: #00ffcc; }
        .btn-active { background: #005544; border-color: #00ffcc; }
        input { padding: 10px; border-radius: 4px; border: 1px solid #555; background: #222; color: white; width: 140px; }
        .section-label { font-size: 0.8rem; color: #888; width: 100%; text-align: center; margin-bottom: 5px; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="info" id="status">Ready to Play</div>
    
    <div class="controls">
        <div class="section-label">Online Multiplayer</div>
        <button onclick="startHosting()">Host Game</button>
        <input type="text" id="roomInput" placeholder="Enter ID to Join">
        <button onclick="joinRoom()">Join Game</button>
    </div>

    <div id="board"></div>

    <div class="controls" style="margin-top: 20px;">
        <div class="section-label">Local Play</div>
        <button id="localBtn" onclick="toggleLocalMultiplayer()">Mode: vs Bot</button>
        <button onclick="resetGame()">Reset Board</button>
        <button onclick="board.flip()">Flip Board</button>
        <button onclick="downloadLog()" style="color: #00ffcc;">Save PGN</button>
    </div>
    
    <div id="log">System Initialized. Play the bot or use Peer IDs for Online.</div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        var board = null;
        var game = new Chess();
        var peer = new Peer(); 
        var conn = null;
        var playerColor = 'w';
        var isLocalMultiplayer = false;

        // --- P2P ONLINE LOGIC ---
        peer.on('open', (id) => {
            addLog("Your Online ID: " + id, "#00ffcc");
        });

        function startHosting() {
            addLog("Waiting for someone to join...", "#ffcc00");
            peer.on('connection', (connection) => {
                conn = connection;
                playerColor = 'w';
                isLocalMultiplayer = false;
                setupConnection();
            });
        }

        function joinRoom() {
            const code = $('#roomInput').val().trim();
            if (!code) return alert("Please enter a Peer ID");
            conn = peer.connect(code);
            playerColor = 'b';
            isLocalMultiplayer = false;
            board.orientation('black');
            setupConnection();
        }

        function setupConnection() {
            conn.on('open', () => {
                $('#status').text("Online Match Active");
                addLog("Opponent Connected!", "#00ffcc");
                conn.on('data', (data) => {
                    game.move(data);
                    board.position(game.fen());
                    updateStatus();
                });
            });
        }

        // --- LOCAL MODES ---
        function toggleLocalMultiplayer() {
            isLocalMultiplayer = !isLocalMultiplayer;
            resetGame();
            if (isLocalMultiplayer) {
                $('#localBtn').text("Mode: Local PvP").addClass('btn-active');
                addLog("Local PvP Enabled. Pass the mouse!", "#00ffcc");
            } else {
                $('#localBtn').text("Mode: vs Bot").removeClass('btn-active');
                addLog("Bot Mode Enabled.", "#ffcc00");
            }
        }

        // --- ADAPTIVE BOT LOGIC ---
        const PST = {
            p: [[100,100,100,100,100,100,100,100],[50,50,50,50,50,50,50,50],[10,10,20,30,30,20,10,10],[5,5,10,25,25,10,5,5],[0,0,0,20,20,0,0,0],[5,-5,-10,0,0,-10,-5,5],[5,10,10,-20,-20,10,10,5],[0,0,0,0,0,0,0,0]],
            n: [[-50,-40,-30,-30,-30,-30,-40,-50],[-40,-20,0,0,0,0,-20,-40],[-30,0,10,15,15,10,0,-30],[-30,5,15,20,20,15,5,-30],[-30,0,15,20,20,15,0,-30],[-30,5,10,15,15,10,5,-30],[-40,-20,0,5,5,0,-20,-40],[-50,-40,-30,-30,-30,-30,-40,-50]],
            b: [[-20,-10,-10,-10,-10,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,10,10,5,0,-10],[-10,5,5,10,10,5,5,-10],[-10,0,10,10,10,10,0,-10],[-10,10,10,10,10,10,10,-10],[-10,5,0,0,0,0,5,-10],[-20,-10,-10,-10,-10,-10,-10,-20]],
            r: [[0,0,0,0,0,0,0,0],[5,10,10,10,10,10,10,5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[0,0,0,5,5,0,0,0]]
        };

        function evaluateBoard(game) {
            let score = 0;
            const b = game.board();
            for (let i = 0; i < 8; i++) {
                for (let j = 0; j < 8; j++) {
                    const p = b[i][j];
                    if (p) {
                        let val = {p:100, n:320, b:330, r:500, q:900, k:20000}[p.type];
                        if (PST[p.type]) val += (p.color === 'w') ? PST[p.type][7-i][j] : PST[p.type][i][j];
                        score += (p.color === 'w' ? -val : val);
                    }
                }
            }
            return score;
        }

        function minimax(game, depth, alpha, beta, isMax) {
            if (depth === 0 || game.game_over()) return evaluateBoard(game);
            const moves = game.moves();
            let bestVal = isMax ? -99999 : 99999;
            for (let m of moves) {
                game.move(m);
                let val = minimax(game, depth - 1, alpha, beta, !isMax);
                game.undo();
                bestVal = isMax ? Math.max(bestVal, val) : Math.min(bestVal, val);
                if (isMax) alpha = Math.max(alpha, bestVal); else beta = Math.min(beta, bestVal);
                if (beta <= alpha) break;
            }
            return bestVal;
        }

        function makeBotMove() {
            if (game.game_over()) return;
            let currentEval = evaluateBoard(game);
            let depth = (currentEval < -500) ? 3 : (currentEval > 500 ? 1 : 2);
            let moves = game.moves();
            let bestMove = moves[0], bestValue = -99999;
            for (let m of moves) {
                game.move(m);
                let v = minimax(game, depth, -100000, 100000, false);
                game.undo();
                if (v >= bestValue) { bestValue = v; bestMove = m; }
            }
            game.move(bestMove);
            board.position(game.fen());
            addLog("Bot: " + bestMove);
            updateStatus();
        }

        // --- HANDLERS ---
        function onDrop(source, target) {
            // Block move if online and not your turn
            if (conn && game.turn() !== playerColor[0]) return 'snapback';

            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            updateStatus();
            addLog("Move: " + move.san);

            if (conn) {
                conn.send(move); 
            } else if (!isLocalMultiplayer) {
                window.setTimeout(makeBotMove, 250);
            }
        }

        function addLog(msg, color = "white") {
            const div = $("<div>").text(msg).css("color", color);
            $('#log').append(div);
            $('#log').scrollTop($('#log')[0].scrollHeight);
        }

        function updateStatus() {
            let status = game.turn() === 'w' ? "White to Move" : (conn ? "Opponent's Turn" : (isLocalMultiplayer ? "Black to Move" : "Bot Thinking..."));
            if (game.in_checkmate()) status = "CHECKMATE!";
            else if (game.in_draw()) status = "DRAW!";
            $('#status').text(status);
        }

        function downloadLog() {
            const pgn = game.pgn();
            const blob = new Blob([pgn], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'match.pgn';
            a.click();
        }

        function resetGame() {
            game = new Chess();
            board.start();
            $('#log').empty();
            updateStatus();
        }

        board = Chessboard('board', {
            draggable: true, position: 'start', onDrop: onDrop,
            onSnapEnd: () => board.position(game.fen()),
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
    </script>
</body>
</html>
