<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess: Adaptive Tactician Bot</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { 
            background: #1a1a1a; 
            color: white; 
            font-family: sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
        }
        #board { 
            width: 400px; 
            max-width: 90vw; 
            border: 5px solid #444; 
        }
        .info { 
            margin: 15px; 
            font-size: 1.1rem; 
            color: #00ffcc; 
        }
        #log { 
            width: 400px; 
            height: 150px; 
            background: #000; 
            margin-top: 10px; 
            font-family: monospace; 
            font-size: 12px; 
            overflow-y: scroll; 
            padding: 5px; 
            color: #00ff00; 
            border: 1px solid #333; 
        }
        button { 
            padding: 10px 15px; 
            cursor: pointer; 
            background: #333; 
            color: white; 
            border: 1px solid #555; 
            border-radius: 4px; 
            margin: 5px; 
        }
    </style>
</head>
<body>

    <div class="info" id="status">White to Move</div>
    <div id="board"></div>

    <div class="controls">
        <button onclick="resetGame()">Reset</button>
        <button onclick="board.flip()">Flip View</button>
    </div>
    
    <div id="log">Bot Engine: Adaptive AI Active...</div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        var board = null;
        var game = new Chess();

        const PST = {
            p: [
                [100, 100, 100, 100, 100, 100, 100, 100],
                [50, 50, 50, 50, 50, 50, 50, 50],
                [10, 10, 20, 30, 30, 20, 10, 10],
                [5,  5, 10, 25, 25, 10,  5,  5],
                [0,  0,  0, 20, 20,  0,  0,  0],
                [5, -5,-10,  0,  0,-10, -5,  5],
                [5, 10, 10,-20,-20, 10, 10,  5],
                [0,  0,  0,  0,  0,  0,  0,  0]
            ],
            n: [
                [-50,-40,-30,-30,-30,-30,-40,-50],
                [-40,-20,  0,  0,  0,  0,-20,-40],
                [-30,  0, 10, 15, 15, 10,  0,-30],
                [-30,  5, 15, 20, 20, 15,  5,-30],
                [-30,  0, 15, 20, 20, 15,  0,-30],
                [-30,  5, 10, 15, 15, 10,  5,-30],
                [-40,-20,  0,  5,  5,  0,-20,-40],
                [-50,-40,-30,-30,-30,-30,-40,-50]
            ],
            b: [
                [-20,-10,-10,-10,-10,-10,-10,-20],
                [-10,  0,  0,  0,  0,  0,  0,-10],
                [-10,  0,  5, 10, 10,  5,  0,-10],
                [-10,  5,  5, 10, 10,  5,  5,-10],
                [-10,  0, 10, 10, 10, 10,  0,-10],
                [-10, 10, 10, 10, 10, 10, 10,-10],
                [-10,  5,  0,  0,  0,  0,  5,-10],
                [-20,-10,-10,-10,-10,-10,-10,-20]
            ],
            r: [
                [0,  0,  0,  0,  0,  0,  0,  0],
                [5, 10, 10, 10, 10, 10, 10,  5],
                [-5,  0,  0,  0,  0,  0,  0, -5],
                [-5,  0,  0,  0,  0,  0,  0, -5],
                [-5,  0,  0,  0,  0,  0,  0, -5],
                [-5,  0,  0,  0,  0,  0,  0, -5],
                [-5,  0,  0,  0,  0,  0,  0, -5],
                [0,  0,  0,  5,  5,  0,  0,  0]
            ]
        };

        function getPieceValue(piece, x, y) {
            const vals = { p: 100, n: 320, b: 330, r: 500, q: 900, k: 20000 };
            let val = vals[piece.type];
            if (PST[piece.type]) {
                val += (piece.color === 'w') ? PST[piece.type][7 - y][x] : PST[piece.type][y][x];
            }
            if (piece.type === 'q' && piece.color === 'b' && y > 1) {
                val -= 400; // Queen Safety
            }
            return val;
        }

        function evaluateBoard(game) {
            let totalScore = 0;
            const board = game.board();
            for (let i = 0; i < 8; i++) {
                for (let j = 0; j < 8; j++) {
                    const piece = board[i][j];
                    if (piece) {
                        const val = getPieceValue(piece, j, i);
                        totalScore += (piece.color === 'w' ? -val : val);
                    }
                }
            }
            return totalScore;
        }

        function minimax(game, depth, alpha, beta, isMaximizingPlayer) {
            if (depth === 0 || game.game_over()) return evaluateBoard(game);
            const moves = game.moves();
            if (isMaximizingPlayer) {
                let bestValue = -99999;
                for (let move of moves) {
                    game.move(move);
                    bestValue = Math.max(bestValue, minimax(game, depth - 1, alpha, beta, false));
                    game.undo();
                    alpha = Math.max(alpha, bestValue);
                    if (beta <= alpha) break; 
                }
                return bestValue;
            } else {
                let bestValue = 99999;
                for (let move of moves) {
                    game.move(move);
                    bestValue = Math.min(bestValue, minimax(game, depth - 1, alpha, beta, true));
                    game.undo();
                    beta = Math.min(beta, bestValue);
                    if (beta <= alpha) break;
                }
                return bestValue;
            }
        }

        function getAdaptiveDepth(currentScore) {
            if (currentScore < -500) return 3; // Harder if user is winning
            if (currentScore > 500) return 1;  // Easier if user is losing
            return 2; // Normal
        }

        function makeBotMove() {
            const moves = game.moves();
            if (game.game_over() || moves.length === 0) { updateStatus(); return; }

            let currentEval = evaluateBoard(game);
            let depth = getAdaptiveDepth(currentEval);
            let bestValue = -99999;
            let bestMoveFound;

            moves.sort((a, b) => (b.includes('x') ? 1 : -1));

            for (let move of moves) {
                game.move(move);
                let value = minimax(game, depth, -100000, 100000, false);
                game.undo();
                if (value >= bestValue) {
                    bestValue = value;
                    bestMoveFound = move;
                }
            }

            // Blunder Mechanic: 20% chance to pick random move if winning significantly
            if (currentEval > 600 && Math.random() < 0.2) {
                bestMoveFound = moves[Math.floor(Math.random() * moves.length)];
                $('#log').prepend("<div style='color: #ffcc00;'>Bot is playing easy...</div>");
            }

            game.move(bestMoveFound);
            board.position(game.fen());
            $('#log').prepend("<div>Bot: <b>" + bestMoveFound + "</b> | Depth: " + (depth+1) + "</div>");
            updateStatus();
        }

        function onDrop(source, target) {
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            updateStatus();
            window.setTimeout(makeBotMove, 250);
        }

        function updateStatus() {
            let status = game.turn() === 'w' ? "White to Move" : "Bot Thinking...";
            if (game.in_checkmate()) status = "Checkmate!";
            else if (game.in_draw()) status = "Draw!";
            $('#status').text(status);
        }

        function resetGame() {
            game.reset();
            board.start();
            $('#log').empty();
            updateStatus();
        }

        board = Chessboard('board', {
            draggable: true,
            position: 'start',
            onDrop: onDrop,
            onSnapEnd: function() { board.position(game.fen()); },
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
    </script>
</body>
</html>
